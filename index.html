<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Menejerlik test</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{margin:0;font-family:Arial;background:#2ecc71;}
.header{padding:20px;color:white}
.card{background:white;border-radius:25px 25px 0 0;padding:20px;min-height:100vh}
.item{padding:15px;border-bottom:1px solid #eee;cursor:pointer}
.item:hover{background:#f1fdf5}
button{background:#27ae60;color:white;border:none;padding:10px;border-radius:8px;margin-top:10px}
input{width:100%;padding:8px;margin:6px 0}
</style>
</head>

<body>

<div class="header">
<h3 id="name"></h3>
<p>ID: <span id="uid"></span></p>
<p>Rol: <b id="role"></b></p>
</div>

<div class="card" id="main">Yuklanmoqda...</div>

<script type="module">

// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCz9DJ1vqZnq5j51ML25FrSNGnLoSY8f9k",
  authDomain: "menejerlik-test.firebaseapp.com",
  projectId: "menejerlik-test",
  storageBucket: "menejerlik-test.firebasestorage.app",
  messagingSenderId: "386110280050",
  appId: "1:386110280050:web:bf227f968a7868be524deb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= TELEGRAM =================
let tg = window.Telegram.WebApp;
tg.ready();

let user = tg.initDataUnsafe.user;
let uid = user?.id || 0;
let name = user?.first_name || "Mehmon";

document.getElementById("name").innerText = "Salom " + name;
document.getElementById("uid").innerText = uid;

// ================= ADMIN =================
const ADMIN_IDS = [8562088626];

let role = ADMIN_IDS.includes(uid) ? "Menejer" : "Foydalanuvchi";
document.getElementById("role").innerText = role;

// ================= RUXSAT TEKSHIRISH =================
async function checkPermit(){
  if(role==="Menejer"){ showAdmin(); return; }

  const ref = doc(db,"permits",String(uid));
  const snap = await getDoc(ref);

  if(!snap.exists()){
    document.getElementById("main").innerHTML =
    `<h2>⛔ Ruxsat yo‘q</h2>
    <p>Admin sizga hali kirish bermagan.</p>
    <p>ID: ${uid}</p>`;
    return;
  }

  showUser();
}

checkPermit();

// ================= ADMIN PANEL =================
function showAdmin(){
document.getElementById("main").innerHTML=`
<h2>Admin panel</h2>

<h3>Ruxsat berish</h3>
<input id="pid" placeholder="Telegram ID">
<button onclick="givePermit()">Berish</button>

<hr>

<h3>Test qo‘shish</h3>
<input id="fan" placeholder="Fan">
<input id="savol" placeholder="Savol">
<input id="a" placeholder="A">
<input id="b" placeholder="B">
<input id="c" placeholder="C">
<input id="d" placeholder="D">
<input id="t" placeholder="To‘g‘ri javob (0-3)">
<button onclick="addTest()">Saqlash</button>
`;
}

// ================= RUXSAT BERISH =================
window.givePermit = async function(){
let id=document.getElementById("pid").value;
await setDoc(doc(db,"permits",String(id)),{allow:true});
alert("Ruxsat berildi");
}

// ================= TEST QO‘SHISH =================
window.addTest = async function(){
await addDoc(collection(db,"tests"),{
fan:fan.value,
savol:savol.value,
javob:[a.value,b.value,c.value,d.value],
togri:Number(t.value)
});
alert("Test qo‘shildi");
}

// ================= FOYDALANUVCHI =================
async function showUser(){
let html="<h2>Testlar</h2>";
const querySnapshot=await getDocs(collection(db,"tests"));
querySnapshot.forEach(doc=>{
let t=doc.data();
html+=`<div class='item' onclick='start("${doc.id}")'>${t.fan} — ${t.savol}</div>`;
});
document.getElementById("main").innerHTML=html;
}

// ================= TEST ISHLASH =================
window.start=async function(id){
const ref=doc(db,"tests",id);
const snap=await getDoc(ref);
let t=snap.data();

let h=`<h3>${t.savol}</h3>`;
t.javob.forEach((j,i)=>{
h+=`<div class="item" onclick="ans(${i},${t.togri})">${j}</div>`;
});
document.getElementById("main").innerHTML=h;
}

window.ans=function(a,b){
if(a==b) alert("To‘g‘ri");
else alert("Noto‘g‘ri");
showUser();
}

</script>
</body>
</html>
